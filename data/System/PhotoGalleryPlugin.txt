%META:TOPICINFO{author="ProjectContributor" comment="" date="1456435698" format="1.1" version="4"}%
%META:TOPICPARENT{name="Plugins"}%
---+!! %SPACEOUT{ "%TOPIC%" }%
%FORMFIELD{"Description"}%
<!--
One line description, required for extensions repository catalog.
   * Set SHORTDESCRIPTION = %25$SHORTDESCRIPTION%25
-->

%TOC%

---++ Description

This plugin renders galleries from photos attached to topics. Galleries render
as a grid of square thumbnails. Thumbnails are created using the
[[https://github.com/mattes/epeg][Epeg]] library ("insanely fast JPEG thumbnail
scaling") via the [[https://metacpan.org/pod/Image::Epeg][Image::Epeg]] Perl
module. Clicking on a thumbnail zooms the image to the original attached
photo. Currently [[http://photoswipe.com][PhotoSwipe]] by Dmitry Semenov is used
to display the photos. It allows zooming and browsing the image gallery with the
keyboard, the mouse and finger swipes on touch devices. This plugin adds a
slideshow functionality not currently present in the original <nop>PhotoSwipe
gallery. The thumbnails expose a tools menu by hovering over their top right
corner. Available tools include losslessly rotating the photo using
[[https://www.kraxel.org/blog/linux/fbida/][exiftran]], editing the attachment
comment, correcting the attachment timestamp to the photo exposure date, moving
the attachment to another topic, and deleting the attachment.

This plugin works only with [[Wikipedia:JPEG][JPEG]] images and it works best
with photos from digital cameras that have [[Wikipedia:EXIF][EXIF]] data
embedded. It needs a fairly recent browser to support various Javascript and
image scaling and transition magic.

See VarPHOTOGALLERY on how to use it.

The plugin ships with a bulk attach script (=tools/photogallerypluginattach.pl=)
with built-in help.

See [[%SYSTEMWEB%.PerlDoc?module=Foswiki::Plugins::PhotoGalleryPlugin][Foswiki::Plugins::PhotoGalleryPlugin]]
for developer details.



---
---++ Screenshots

Here are a few screenshots of the plugin in action:

%IMAGE{ "screenshot0.jpg" width="621" height="370" type="frame" align="none" caption="example gallery with info tooltip, zoomed image, upload form" }%
%IMAGE{ "screenshot1.jpg" width="346" height="173" type="frame" align="none" caption="grid of square thumbnails" }%
%IMAGE{ "screenshot4.jpg" width="313" height="198" type="frame" align="none" caption="image zoomed and shown in !PhotoSwipe gallery, caption composed from attachment comment and EXIF meta data" }%
%IMAGE{ "screenshot2.jpg" width="283" height="127" type="frame" align="none" caption="action menu pops up when hovering the top right corner of the thumbnail" }%
%IMAGE{ "screenshot3.jpg" width="264" height="144" type="frame" align="none" caption="edit attachment comment dialog" }%





---
---++ Preferences

---+++ Plugin Configuration and Defaults

The following settings are available in the [[%SCRIPTURLPATH{"configure"}%][configure]]
interface:

   * path to the =exiftran= utility (={Plugins}{PhotoGalleryPlugin}{ExifTranPath}=)
   * the default thumbnail quality factor (={Plugins}{PhotoGalleryPlugin}{QualityDefault}=)
   * the default time format to render timestamps (={Plugins}{PhotoGalleryPlugin}{DateFmtDefault}=)
   * the default caption format for thumbnails and photos (={Plugins}{PhotoGalleryPlugin}{CaptFmtDefault}=)
   * the default admin mode (={Plugins}{PhotoGalleryPlugin}{AdminDefault}=)
   * the default thumbnail size (={Plugins}{PhotoGalleryPlugin}{SizeDefault}=)

The plugin does not use any [[%SYSTEMWEB%.PreferenceSettings][preference settings]].

---+++ Skin Extension

This plugin comes with a [[%SYSTEMWEB%.Skins][skin]] extension that adds two options
(checkboxes) to the upload form, namely

   * an option to activate lossless rotation of JPEG images based on EXIF camera
     orientation meta data, and
   * an option to set the attachment upload date to the photo exposure time
     (from EXIF).

The skin extension comes with two [[%SYSTEMWEB%.SkinTemplates][skin templates]] that
add the options to the [[%SYSTEMWEB%.PatternSkin][PatternSkin]]'s and the
[[Foswiki:Extensions/TopicInteractionPlugin][TopicInteractionPlugin]]'s upload
form.




---
---++ Installation

---+++ Plugin

%$INSTALL_INSTRUCTIONS%

This plugin needs the [[https://www.kraxel.org/blog/linux/fbida/][exiftran]]
utility installed on the system in order to provide the photo rotation feature
described above. In Linux distributions the package is typically called
"exiftran" and can be installed through "package managers" or "software
centres". Try the command =sudo apt-get install exiftran= on Debian and
derivates.

The [[https://metacpan.org/pod/Image::Epeg][Image::Epeg]] Perl module might not
be available as a system package. It can be downloaded from CPAN and be built and installed
manually (see e.g. [[http://www.cpan.org/modules/INSTALL.html][here]]).

---+++ Skin Extension

To activate the upload form options described above add (prepend) =photogallery=
to the =SKIN= list in [[%LOCALSITEPREFS%]]. See [[Skins]] for details.

---+++ Cache

The plugin caches data (EXIF meta data, thumbnails) in the
=working/work_areas/PhotoSwipePlugin= directory. It will keep the timestamps of
the used files up-to-date. The plugin ships with a script to clean up the cache
by removing old files from the cache directory. It is suggested to install a
cronjob to run the script on a regular basis. Run
=tools/photogalleryplugincleanup.pl -h= to see the built-in help for more
details. Alternatively, standard system tools, such as "tmpreaper", can be used
to remove old files. No harm is done removing them all from time to time.


---+++ Bulk Upload

The standard Foswiki file upload mechnism is not exactly suitable to upload many
photos. There are a number of alternatives:

   * Use the bulk attach script shipped with this plugin
     (=tools/photogallerypluginattach.pl=). The script must be executed on the
     server where Foswiki is running. It can then attach any number of photos to
     a topic. The image files must reside on the server, too. Note that the
     script must be executed as the server Foswiki (or the web server) is
     running as.
   * The [[Foswiki:Extensions/TopicInteractionPlugin][TopicInteractionPlugin]]
     replaces the standard upload form with a multi-file upload mechanism (plus
     some more attachment manipulation features). If you do not like its
     "interaction stuff" it adds to the view template you can disable that by
     removing =templates/view.topicinteraction.tmpl=.
   * A number of other plugins used to be available
     ([[Foswiki:Extensions/UploadPlugin][UploadPlugin]],
     [[Foswiki:Extensions/BatchUploadPlugin][BatchUploadPlugin]], maybe more)
     but I think they no longer work in today's Foswiki.


---+++ Upgrading

If you have page caching enabled you may need to clear the page cache after
upgrading this plugin. See [[%SYSTEMWEB%.PageCaching][PageCaching]] for details.


---
---++ Dependencies

%$DEPENDENCIES%

---
---++ Change History

%TABLE{ columnwidths="7em,2em" tablewidth="100%" tablerules="all" sort="off" }%
| *Date*        |  *Version*  | *Comment*   |
|  16 May 2016  |     v1.3    | \
- add possibility to automatically split galleries into individual days by injecting customisable headings %BR% \
- minor documentation improvements  |
|  1 May 2016   |     v1.2    | \
- add cache cleanup script%BR% \
- improve bulk upload script%BR% \
- force meta data and thumbnail cache update when attachment version changes%BR% \
- fix plugin crash when all attachments are unreadable (file gone, but FILEATTACHMENT still there)%BR% \
- fix display of timestamp admin menu entry%BR% \
- allow saving empty comment%BR% \
- improved various bits in the plugin code  |
|  21 Apr 2016  |     v1.1    | \
- cleanup and improve docu%BR% \
- fix setting EXIF exposure date on upload%BR% \
- add bulk upload script   |
|  15 Apr 2016  |     v1.0    | \
- initial released version     |




%META:FILEATTACHMENT{name="screenshot0.jpg" attachment="screenshot0.jpg" comment="plugin screenshot" date="1460910771" size="160970" user="PhilippeKehl" version="1"}%
%META:FILEATTACHMENT{name="screenshot1.jpg" attachment="screenshot1.jpg" comment="plugin screenshot" date="1456439258" size="45945" user="PhilippeKehl" version="1"}%
%META:FILEATTACHMENT{name="screenshot2.jpg" attachment="screenshot2.jpg" comment="plugin screenshot" date="1456439258" size="27609" user="PhilippeKehl" version="1"}%
%META:FILEATTACHMENT{name="screenshot3.jpg" attachment="screenshot3.jpg" comment="plugin screenshot" date="1456439258" size="25858" user="PhilippeKehl" version="1"}%
%META:FILEATTACHMENT{name="screenshot4.jpg" attachment="screenshot4.jpg" comment="plugin screenshot" date="1456439258" size="30404" user="PhilippeKehl" version="1"}%
%META:FORM{name="PackageForm"}%
%META:FIELD{name="Author" title="Author" value="[[Foswiki:Main/PhilippeKehl][Philippe Kehl]]"}%
%META:FIELD{name="Version" title="Version" value="%25$VERSION%25"}%
%META:FIELD{name="Release" title="Release" value="%25$RELEASE%25"}%
%META:FIELD{name="Description" title="Description" value="%25$SHORTDESCRIPTION%25"}%
%META:FIELD{name="Repository" title="Repository" value="https://github.com/phkehl/PhotoGalleryPlugin"}%
%META:FIELD{name="Copyright" title="Copyright" value="&copy; 2016 Philippe Kehl, https://oinkzwurgl.org"}%
%META:FIELD{name="License" title="License" value="GPL ([[http://www.gnu.org/copyleft/gpl.html][GNU General Public License]])"}%
%META:FIELD{name="Home" title="Home" value="https://foswiki.org/Extensions/%25$ROOTMODULE%25"}%
%META:FIELD{name="Support" title="Support" value="https://foswiki.org/Support/%25$ROOTMODULE%25"}%
%META:FIELD{name="ExtensionClassification" title="ExtensionClassification" value="Interface and Visualisation"}%
%META:FIELD{name="ExtensionType" title="ExtensionType" value="PluginPackage"}%
%META:FIELD{name="Compatibility" title="[[Compatibility]]" value="Foswiki 2.1, modern HTML5 browsers, Linux server, some exotic Perl modules"}%
%META:FIELD{name="IncompatibleWith" title="[[IncompatibleWith]]" value="2.0.3, 2.0.2, 2.0.1, 2.0.0, 1.1.10, 1.1.9, 1.1.8, 1.1.7, 1.1.6, 1.1.5, 1.1.4, 1.1.3, 1.1.2, 1.1.1, 1.1.0, 1.0.10, 1.0.9, 1.0.8, 1.0.7, 1.0.6, 1.0.5, 1.0.4, 1.0.3, 1.0.2, 1.0.1, 1.0.0"}%
